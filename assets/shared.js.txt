// ====== بيانات تجريبية مبسّطة ======
const DEMO = {
  projects:[
    {id:1,name:'سقيا الماء',owner:'جمعية البر',start:'2026-01-01',end:'2026-06-30',progress:65,budget:300000,spent:280000,status:'جارٍ',region:'الرياض'},
    {id:2,name:'التحول الرقمي',owner:'وزارة الاتصالات',start:'2026-03-01',end:'2026-03-30',progress:90,budget:2000000,spent:1800000,status:'مكتمل',region:'الرياض'}
  ],
  speakers:[
    {id:11,name:'م. أحمد المطيري',topic:'الأمن السيبراني',org:'شركة تقنية',status:'بانتظار التحقق'},
    {id:12,name:'د. سارة العبدالله',topic:'الذكاء الاصطناعي',org:'جامعة',status:'متحقق'}
  ],
  solutions:[
    {code:'S-01',title:'منصة حملات تبرع سريعة',for:'غير ربحي',desc:'إطلاق حملات وربط الدفع وخارطة الأثر.'},
    {code:'S-02',title:'سوق مرافق وفعاليات',for:'جامعات/خاص',desc:'حجز المرافق ومتابعة الاستخدام.'},
    {code:'S-03',title:'بوابة الرعايات الوطنية',for:'حكومة/إمارات',desc:'إدارة الفرص وتوثيق مساهمات CSR.'},
    {code:'S-04',title:'مؤشرات أداء تنموية',for:'وطني',desc:'لوحات أثر وربط بالمشاريع.'}
  ],
  facilities:[
    {id:11,provider:'جامعة الملك سعود',name:'قاعة المؤتمرات A',city:'الرياض',capacity:300,status:'متاح'},
    {id:12,provider:'شركة تقنية',name:'مسرح الابتكار',city:'جدة',capacity:500,status:'متاح'}
  ],
  trainers:[
    {id:21,name:'د. سارة العبدالله',topic:'تحليل البيانات',mode:'عن بعد',rating:4.8},
    {id:22,name:'م. سالم الشمري',topic:'ريادة الأعمال',mode:'حضوري',rating:4.6}
  ]
};

// ====== أدوات مساعدة ======
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

// ====== واجهة الحساب (يمين) ======
function buildSidebar(activeRoute){
  const isAccount = location.pathname.includes('/accounts/');
  const rel = isAccount ? '..' : '.';
  const side = document.createElement('aside');
  side.className = 'sidebar';

  side.innerHTML = `
    <div class="flex items-center gap-3 mb-4">
      <img src="${rel}/assets/hasseef-logo.svg" alt="Hasseef" width="40" height="40" class="rounded">
      <div><div class="font-extrabold">منصة حصيف</div><div class="text-xs text-slate-500">بوابة التكامل</div></div>
    </div>

    <div class="text-xs text-slate-500 mb-2">الحسابات</div>
    <nav id="accountsNav" class="space-y-1">
      <a class="sidebar-item" href="${rel}/accounts/gov.html" data-route="gov"><i data-lucide="building-2"></i> الحكومة</a>
      <a class="sidebar-item" href="${rel}/accounts/emirate.html" data-route="emirate"><i data-lucide="shield-check"></i> الإمارة</a>
      <a class="sidebar-item" href="${rel}/accounts/private.html" data-route="private"><i data-lucide="factory"></i> القطاع الخاص</a>
      <a class="sidebar-item" href="${rel}/accounts/nonprofit.html" data-route="nonprofit"><i data-lucide="heart-handshake"></i> غير الربحي</a>
      <a class="sidebar-item" href="${rel}/accounts/university.html" data-route="university"><i data-lucide="graduation-cap"></i> الجامعات</a>
      <a class="sidebar-item" href="${rel}/accounts/individual.html" data-route="individual"><i data-lucide="user"></i> الأفراد</a>
      <a class="sidebar-item" href="${rel}/accounts/donor.html" data-route="donor"><i data-lucide="hand-coins"></i> المانحون</a>
      <a class="sidebar-item" href="${rel}/accounts/partners.html" data-route="partners"><i data-lucide="handshake"></i> الشركاء الاستراتيجيون</a>
    </nav>

    <div class="text-xs text-slate-500 mt-6 mb-2">روابط عامة</div>
    <nav class="space-y-1">
      <a class="sidebar-item" href="${rel}/index.html"><i data-lucide="home"></i> الرئيسية</a>
      <a class="sidebar-item" href="${rel}/index.html#services"><i data-lucide="app-window"></i> الخدمات</a>
      <a class="sidebar-item" href="${rel}/index.html#impact"><i data-lucide="bar-chart-big"></i> لوحة الأثر</a>
      <a class="sidebar-item" href="${rel}/index.html#privacy"><i data-lucide="lock"></i> الخصوصية</a>
      <a class="sidebar-item" href="${rel}/index.html#terms"><i data-lucide="scroll-text"></i> الاتفاقية</a>
    </nav>

    <div class="text-xs text-slate-400 mt-6">© حصيف — v21</div>
  `;

  $$('#accountsNav a', side).forEach(a=>{
    a.classList.toggle('active', a.dataset.route===activeRoute);
  });
  if (window.lucide) lucide.createIcons();
  return side;
}

function buildTopbar(title){
  const top = document.createElement('div');
  top.className = 'topbar';
  top.innerHTML = `
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="text-sm text-slate-500">${title}</div>
      <div class="flex items-center gap-2">
        <button class="btn" onclick="toggleNotify(true)"><i data-lucide="bell"></i></button>
        <a href="../index.html#support" class="btn"><i data-lucide="life-buoy"></i> الدعم</a>
      </div>
    </div>`;
  return top;
}

function buildLayout(activeRoute, title){
  const container = document.createElement('div');
  container.className = 'layout';
  const main = document.createElement('main'); main.id='pageMain';
  main.appendChild(buildTopbar(title));
  const content = document.createElement('section'); content.id='app'; content.className='space-y-3';
  main.appendChild(content);
  container.appendChild(main);
  container.appendChild(buildSidebar(activeRoute)); // الشريط الجانبي على اليمين
  document.body.prepend(container);
  if (window.lucide) lucide.createIcons();
  return content;
}

// ====== تبويبات + جداول ======
function makeTabs(root, tabs){
  const nav=document.createElement('div'); nav.className='tabs';
  const area=document.createElement('div'); const panels={}; let i=0;
  for(const [label, html] of Object.entries(tabs)){
    const btn=document.createElement('button'); btn.className='tab'; btn.textContent=label;
    btn.addEventListener('click',()=>{
      nav.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      for(const k in panels){ panels[k].style.display = (k===label)?'block':'none'; }
    });
    if(i===0) btn.classList.add('active');
    nav.appendChild(btn);
    const p=document.createElement('div'); p.style.display=(i===0)?'block':'none'; p.innerHTML=html;
    panels[label]=p; area.appendChild(p); i++;
  }
  root.appendChild(nav); root.appendChild(area);
  tableEnhance(root);
}
function tableEnhance(root){
  root.querySelectorAll('table.interactive').forEach(table=>{
    const bar=document.createElement('div'); bar.className='flex items-center gap-2 my-2';
    const s=document.createElement('input'); s.placeholder='ابحث...'; s.className='search max-w-sm';
    const c=document.createElement('div'); c.className='text-xs text-slate-500';
    bar.appendChild(s); bar.appendChild(c); table.parentElement.insertBefore(bar,table);
    function filter(){ const q=s.value.toLowerCase(); let vis=0;
      table.querySelectorAll('tbody tr').forEach(tr=>{ const ok=tr.innerText.toLowerCase().includes(q); tr.style.display=ok?'':'none'; if(ok)vis++; });
      c.textContent=vis+' / '+table.tBodies[0].rows.length+' صف';
    } s.addEventListener('input',filter); filter();
  });
}

// ====== ألواح مشتركة ======
function panelProjects(){
  const rows = DEMO.projects.map(p=>`
    <tr>
      <td>${p.name}</td><td>${p.owner}</td><td>${p.start} → ${p.end}</td>
      <td><div class='w-40 h-2 bg-slate-200 rounded'><div style='width:${p.progress}%;background:var(--brand);height:8px;border-radius:6px'></div></div></td>
      <td>${p.spent.toLocaleString()} / ${p.budget.toLocaleString()}</td><td>${p.status}</td>
    </tr>`).join('');
  return `
  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <div class="section-title"><i data-lucide="list-checks"></i> المشاريع</div>
      <div class="flex gap-2">
        <button class="btn" onclick="exportCSV('projectsTable')"><i data-lucide="table"></i> تصدير CSV</button>
        <button class="btn" onclick="openFilePicker()"><i data-lucide="plus"></i> إضافة مشروع</button>
      </div>
    </div>
    <div class="overflow-auto">
      <table id="projectsTable" class="interactive">
        <thead><tr><th>المشروع</th><th>الجهة</th><th>المدة</th><th>الإنجاز</th><th>الميزانية/المصروف</th><th>الحالة</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  </div>`;
}
function panelSolutions(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="app-window"></i> سوق الحلول</div>
    <div class="grid4">
      ${DEMO.solutions.map(s=>`
        <article class="card">
          <div class="flex items-center justify-between"><div class="font-bold">${s.title}</div><span class="badge">${s.for}</span></div>
          <p class="text-sm text-slate-600 mt-1">${s.desc}</p>
          <div class="mt-3 flex gap-2">
            <button class="btn btn-accent" onclick="openFilePicker()"><i data-lucide="send"></i> طلب الحل</button>
            <button class="btn"><i data-lucide="circle-help"></i> تفاصيل</button>
          </div>
        </article>`).join('')}
    </div>
  </div>`;
}
function panelPrinceRequest(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="medal"></i> طلب رعاية الأمير (تُرسل من القطاعات)</div>
    <p class="text-sm text-slate-600">ترفع الجهات طلب الرعاية، وتقوم الإمارة بالمراجعة والاعتماد/الرفض. أرفق المتطلبات كاملة.</p>
    <div class="mt-2"><button class="btn btn-primary" onclick="openPrinceModal()"><i data-lucide="file-plus"></i> فتح نموذج الطلب</button></div>
  </div>`;
}
function panelEmirateApproval(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="file-check-2"></i> طلبات رعاية الأمير — مراجعة الإمارة</div>
    <div class="overflow-auto">
      <table class="interactive"><thead><tr><th>المبادرة</th><th>الجهة</th><th>الحالة</th><th>إجراء</th></tr></thead>
      <tbody>
        <tr><td>منتدى الابتكار الإقليمي</td><td>جامعة الملك سعود</td><td>قيد المراجعة</td>
          <td>
            <button class="btn btn-primary text-xs">اعتماد</button>
            <button class="btn text-xs" onclick="document.getElementById('emirateReview').style.display='block'">تقييم تفصيلي</button>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div id="emirateReview" class="hidden mt-3 card">
      <div class="font-semibold mb-2">نموذج تقييم تفصيلي</div>
      <div class="grid2">
        <select class="search"><option>الأثر المتوقع</option><option>عالٍ</option><option>متوسط</option><option>منخفض</option></select>
        <select class="search"><option>الجاهزية التنفيذية</option><option>مكتملة</option><option>جزئية</option><option>منخفضة</option></select>
        <select class="search"><option>التوافق مع المستهدفات</option><option>عالي</option><option>متوسط</option><option>منخفض</option></select>
        <input class="search" placeholder="مؤشرات (KPI)">
        <textarea class="search" rows="3" placeholder="ملاحظات الإمارة"></textarea>
      </div>
      <div class="mt-3"><button class="btn" onclick="openFilePicker()"><i data-lucide="paperclip"></i> مرفقات</button></div>
      <div class="mt-3 flex gap-2 justify-end">
        <button class="btn">حفظ مسودة</button><button class="btn btn-primary">اعتماد</button><button class="btn">رفض</button>
      </div>
    </div>
  </div>`;
}
function panelSpeakerVetting(){
  const rows = DEMO.speakers.map(s=>`
    <tr><td>${s.name}</td><td>${s.topic}</td><td>${s.org}</td><td>${s.status}</td>
    <td><button class="btn text-xs">تحديث</button></td></tr>`).join('');
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="shield"></i> المسح الأمني للمتحدثين</div>
    <div class="grid3">
      <input class="search" placeholder="اسم المتحدث">
      <input class="search" placeholder="الفعالية/الجهة">
      <input class="search" placeholder="المجال">
    </div>
    <div class="mt-3 overflow-auto">
      <table class="interactive"><thead><tr><th>الاسم</th><th>التخصص</th><th>الجهة</th><th>الحالة</th><th>إجراء</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>
  </div>`;
}
function panelFacilities(){
  const rows = DEMO.facilities.map(f=>`
    <tr><td>${f.name}</td><td>${f.provider}</td><td>${f.city}</td><td>${f.capacity}</td><td>${f.status}</td>
    <td><button class="btn btn-primary text-xs">طلب حجز</button></td></tr>`).join('');
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="building-2"></i> المرافق والفعاليات</div>
    <div class="grid3">
      <input class="search" placeholder="نوع المرفق">
      <input class="search" placeholder="المدينة">
      <button class="btn btn-accent">بحث</button>
    </div>
    <div class="mt-3 overflow-auto">
      <table class="interactive"><thead><tr><th>المرفق</th><th>المزود</th><th>المدينة</th><th>السعة</th><th>الحالة</th><th>طلب</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>
  </div>`;
}
function panelConsultations(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="message-circle"></i> الاستشارات</div>
    <div class="grid3">
      <input class="search" placeholder="الموضوع">
      <select class="search"><option>حوكمة</option><option>أثر اجتماعي</option><option>تقني/بيانات</option></select>
      <button class="btn btn-primary" onclick="openFilePicker()"><i data-lucide="file-plus"></i> طلب استشارة</button>
    </div>
  </div>`;
}
function panelWallet(title){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="wallet"></i> ${title}</div>
    <div class="grid4">
      <div class="kpi"><div class="text-sm text-slate-600">إجمالي الحافظة</div><div class="text-2xl font-extrabold">6.4M</div></div>
      <div class="kpi"><div class="text-sm text-slate-600">مصروف</div><div class="text-2xl font-extrabold">4.1M</div></div>
      <div class="kpi"><div class="text-sm text-slate-600">متبقي</div><div class="text-2xl font-extrabold">2.3M</div></div>
      <div class="kpi"><div class="text-sm text-slate-600">مشاريع ممولة</div><div class="text-2xl font-extrabold">27</div></div>
    </div>
  </div>`;
}
function panelAI(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="bot"></i> المستشار الذكي (تجريبي)</div>
    <textarea class="search" rows="3" placeholder="اسأل: اقترح خطة رفع نسبة الإنجاز لمبادرة التشجير"></textarea>
    <div class="mt-2"><button class="btn btn-accent"><i data-lucide="sparkles"></i> تحليل</button></div>
  </div>`;
}
function panelJobs(){
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="briefcase"></i> الوظائف والتدريب والتطوع</div>
    <p class="text-sm text-slate-600">لوحة فرص موحدة حسب الحساب (عرض تجريبي).</p>
    <div class="mt-2"><button class="btn btn-accent" onclick="openFilePicker()"><i data-lucide="send"></i> تقديم</button></div>
  </div>`;
}
function panelTrainers(){
  const rows = DEMO.trainers.map(t=>`
    <tr><td>${t.name}</td><td>${t.topic}</td><td>${t.mode}</td><td>${t.rating}</td>
      <td><button class="btn btn-primary text-xs">طلب</button></td></tr>`).join('');
  return `
  <div class="card">
    <div class="section-title"><i data-lucide="mic-2"></i> المدربون والمتحدثون</div>
    <div class="overflow-auto">
      <table class="interactive"><thead><tr><th>الاسم</th><th>المجال</th><th>النمط</th><th>التقييم</th><th>طلب</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>
  </div>`;
}

// ====== تعريف تبويبات كل حساب ======
const ACCOUNT_TABS = {
  gov:{ title:'حساب الحكومة', tabs:{
    '📊 المشاريع': panelProjects(),
    '🧩 سوق الحلول': panelSolutions(),
    '🎯 فرص الرعاية (طلب الأمير)': panelPrinceRequest(),
    '🏟️ المرافق والفعاليات': panelFacilities(),
    '💡 الاستشارات': panelConsultations(),
    '💰 المحفظة': panelWallet('محفظة حكومية'),
    '🤖 الذكاء الاصطناعي': panelAI(),
    '📈 المؤشرات والتقارير': `<div class='card'><div class='section-title'><i data-lucide="chart-column"></i> المؤشرات والتقارير</div><button class='btn' onclick="exportCSV('projectsTable')"><i data-lucide="table"></i> تصدير CSV</button></div>`
  }},
  emirate:{ title:'حساب الإمارة', tabs:{
    '🎯 مراجعة رعاية الأمير': panelEmirateApproval(),
    '🛡️ المسح الأمني للمتحدثين': panelSpeakerVetting(),
    '📊 المشاريع': panelProjects(),
    '💰 المحفظة': panelWallet('محفظة الإمارة'),
    '🤖 الذكاء الاصطناعي': panelAI(),
    '📈 المؤشرات والتقارير': `<div class='card'><div class='section-title'><i data-lucide="chart-column"></i> المؤشرات والتقارير</div><button class='btn' onclick="exportCSV('projectsTable')">تصدير CSV</button></div>`
  }},
  private:{ title:'حساب القطاع الخاص', tabs:{
    '🧩 سوق الحلول': panelSolutions(),
    '🤝 فرص CSR الوطنية': panelPrinceRequest(),
    '🏟️ المرافق والفعاليات': panelFacilities(),
    '💡 الاستشارات': panelConsultations(),
    '💳 محفظة CSR': panelWallet('محفظة CSR'),
    '🧑‍💼 الوظائف/التدريب/التطوع': panelJobs(),
    '🎤 المدربون والمتحدثون': panelTrainers(),
    '🤖 الذكاء الاصطناعي': panelAI(),
    '📈 المؤشرات والتقارير': `<div class='card'><div class='section-title'><i data-lucide="chart-column"></i> المؤشرات والتقارير</div><button class='btn' onclick="exportCSV('projectsTable')">تصدير CSV</button></div>`
  }},
  nonprofit:{ title:'حساب القطاع غير الربحي', tabs:{
    '📊 المشاريع/الحملات': panelProjects(),
    '🧩 سوق الحلول': panelSolutions(),
    '🎯 فرص الرعاية (طلب الأمير)': panelPrinceRequest(),
    '🤝 التطوع': panelJobs(),
    '💡 الاستشارات': panelConsultations(),
    '💰 المحفظة': panelWallet('محفظة الجمعيات'),
    '🤖 الذكاء الاصطناعي': panelAI(),
    '📈 المؤشرات والتقارير': `<div class='card'><div class='section-title'><i data-lucide="chart-column"></i> المؤشرات والتقارير</div><button class='btn' onclick="exportCSV('projectsTable')">تصدير CSV</button></div>`
  }},
  university:{ title:'حساب الجامعات', tabs:{
    '🎓 التدريب التعاوني': panelJobs(),
    '🧩 سوق الحلول': panelSolutions(),
    '🏟️ المرافق والفعاليات': panelFacilities(),
    '🚀 الحاضنات/المسرعات': `<div class='card'><div class='section-title'><i data-lucide="rocket"></i> إدارة الحاضنات</div><p class='text-sm text-slate-600'>دفعات ومشاريع ناشئة (Pitch + مرفقات).</p><button class='btn' onclick='openFilePicker()'>+ إرفاق مستندات</button></div>`,
    '🎯 فرص الرعاية (طلب الأمير)': panelPrinceRequest(),
    '💳 المحفظة البحثية': panelWallet('محفظة البحوث'),
    '💡 الاستشارات': panelConsultations(),
    '🤖 الذكاء الاصطناعي': panelAI(),
    '📈 المؤشرات والتقارير': `<div class='card'><div class='section-title'><i data-lucide="chart-column"></i> المؤشرات والتقارير</div><button class='btn' onclick="exportCSV('projectsTable')">تصدير CSV</button></div>`
  }},
  individual:{ title:'حساب الأفراد', tabs:{
    '🧭 تحديد الميول والرغبات': `<div class='card'><div class='section-title'><i data-lucide="compass"></i> اختبار الميول (تجريبي)</div><p class='text-sm text-slate-600'>أجب على أسئلة قصيرة لنوصي بمسارات تعليمية/وظيفية/تجارية مناسبة.</p><button class='btn btn-accent'>بدء الاختبار</button></div>`,
    '🧑‍💼 الوظائف/التدريب/التطوع': panelJobs(),
    '🎤 التقديم كمتحدث/مدرب': `<div class='card'><div class='section-title'><i data-lucide="mic-2"></i> التقديم كمتحدث/مدرب</div><button class='btn btn-accent' onclick='openFilePicker()'>تقديم</button></div>`,
    '💡 الاستشارات': panelConsultations(),
    '💳 المحفظة الشخصية': panelWallet('محفظة شخصية'),
    '🤖 المستشار الذكي': panelAI()
  }},
  donor:{ title:'حساب المانحين', tabs:{
    '🎁 برامج المنح': `<div class='card'><div class='section-title'><i data-lucide="gift"></i> إدارة برامج المنح</div><button class='btn' onclick='openFilePicker()'>+ مرفقات</button></div>`,
    '🎯 رعاية المبادرات (طلب الأمير)': panelPrinceRequest(),
    '💳 محفظة المنح': panelWallet('محفظة المنح'),
    '📈 تقارير الأثر': `<div class='card'><div class='section-title'><i data-lucide="chart-line"></i> تقارير الأثر</div><button class='btn' onclick="exportCSV('projectsTable')">تصدير CSV</button></div>`,
    '🤖 الذكاء الاصطناعي': panelAI()
  }},
  partners:{ title:'حساب الشركاء الاستراتيجيين', tabs:{
    'منظور الشريك': `
      <div class="grid4">
        <div class="card"><div class="section-title"><i data-lucide="hand-coins"></i> بنك التنمية</div>
          <p class="text-sm text-slate-600">برامج التمويل، المنح المصغّرة، توافق CSR.</p>
          ${panelWallet('محفظة الشريك')}
        </div>
        <div class="card"><div class="section-title"><i data-lucide="factory"></i> منشآت</div>
          <p class="text-sm text-slate-600">تمكين المنشآت، مسرعات، مساحات عمل، ربط الفرص.</p>
          <div class="kpi"><div class="text-sm">منشآت مدعومة</div><div class="text-2xl font-extrabold">540</div></div>
        </div>
        <div class="card"><div class="section-title"><i data-lucide="heart-handshake"></i> المركز الوطني غير الربحي</div>
          <p class="text-sm text-slate-600">حوكمة الجمعيات، الاعتمادات، الأثر الاجتماعي.</p>
          <div class="kpi"><div class="text-sm">جمعيات مُمكّنة</div><div class="text-2xl font-extrabold">220</div></div>
        </div>
        <div class="card"><div class="section-title"><i data-lucide="land-plot"></i> هيئات التطوير</div>
          <p class="text-sm text-slate-600">مشاريع المناطق، الرؤى الحضرية، الربط بالجهات.</p>
          <div class="kpi"><div class="text-sm">مشاريع قيد التنفيذ</div><div class="text-2xl font-extrabold">37</div></div>
        </div>
        <div class="card"><div class="section-title"><i data-lucide="goal"></i> مركز أداء</div>
          <p class="text-sm text-slate-600">مؤشرات وطنية، قياس أداء، لوحات متابعة.</p>
          <div class="kpi"><div class="text-sm">مؤشرات معتمدة</div><div class="text-2xl font-extrabold">68</div></div>
        </div>
      </div>`
  }}
};

// ====== إقلاع حساب ======
function bootAccount(slug){
  const conf = ACCOUNT_TABS[slug];
  const content = buildLayout(slug, conf.title);
  const host = document.createElement('div');
  host.className='card';
  host.innerHTML = `<div class="section-title"><i data-lucide="layout-dashboard"></i> ${conf.title}</div><div id="tabs"></div>`;
  content.appendChild(host);
  makeTabs($('#tabs',host), conf.tabs);
  if (window.lucide) lucide.createIcons();
}

// ====== ميزات عامة (مرفقات/CSV/تنبيهات/نموذج رعاية الأمير) ======
function exportCSV(tableId){
  const rows=[...document.querySelectorAll(`#${tableId} tr`)].map(tr=>[...tr.children].map(td=>`"${td.innerText.replace(/"/g,'""')}"`).join(','));
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=tableId+'.csv'; a.click();
}
let _files=[];
function openFilePicker(){ document.getElementById('filePicker')?.click(); }
function attachFiles(e){
  _files = Array.from(e.target.files||_files);
  const panel = document.getElementById('attachmentsPanel');
  if(panel){
    panel.innerHTML = _files.map((f,i)=>`<div class="text-sm flex items-center justify-between border rounded p-2 mb-1"><span>${f.name} — ${(f.size/1024).toFixed(1)} KB</span><button class="btn text-xs" onclick="removeFile(${i})">حذف</button></div>`).join('');
    panel.classList.toggle('hidden', _files.length===0);
  }
}
function removeFile(i){ _files.splice(i,1); attachFiles({target:{files:_files}}); }
function openPrinceModal(){ const m = document.getElementById('princeModal'); if(m) m.style.display='flex'; }
function closePrinceModal(){ const m = document.getElementById('princeModal'); if(m) m.style.display='none'; }
function toggleNotify(show){
  let p = document.getElementById('notifyPanel');
  if(!p){
    p = document.createElement('div'); p.id='notifyPanel'; p.className='modal'; p.innerHTML = `
      <div class="box">
        <div class="flex items-center justify-between">
          <div class="font-bold">التنبيهات</div>
          <button class="btn text-xs" onclick="toggleNotify(false)">إغلاق</button>
        </div>
        <ul class="list-disc pr-6 text-sm mt-2">
          <li>وصول طلب رعاية جديد من جامعة الملك سعود</li>
          <li>مرفقات ناقصة لطلب CSR #392</li>
          <li>اعتماد الإمارة لطلب رعاية الأمير: منتدى الابتكار</li>
        </ul>
      </div>`;
    document.body.appendChild(p);
  }
  p.style.display = show ? 'flex' : 'none';
}
